# üîó –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –≤–µ–±—Ö—É–∫ —Å–µ—Ä–≤–µ—Ä–∞ AmoCRM

## üìã –û–±–∑–æ—Ä

–í–µ–±—Ö—É–∫ —Å–µ—Ä–≤–µ—Ä –¥–ª—è AmoCRM –ø–æ–∑–≤–æ–ª—è–µ—Ç –ø–æ–ª—É—á–∞—Ç—å real-time —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –≤ –ª–∏–¥–∞—Ö –∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö. –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é –¥–∞–Ω–Ω—ã—Ö –º–µ–∂–¥—É amoCRM –∏ –Ω–∞—à–µ–π —Å–∏—Å—Ç–µ–º–æ–π.

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    HTTP POST    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    Database    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   amoCRM    ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ  Webhook Server ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫ ‚îÇ PostgreSQL  ‚îÇ
‚îÇ             ‚îÇ                 ‚îÇ                 ‚îÇ                ‚îÇ             ‚îÇ
‚îÇ  - Leads    ‚îÇ                 ‚îÇ  - Validation   ‚îÇ                ‚îÇ  - Leads    ‚îÇ
‚îÇ  - Contacts ‚îÇ                 ‚îÇ  - Processing   ‚îÇ                ‚îÇ  - Contacts ‚îÇ
‚îÇ  - Events   ‚îÇ                 ‚îÇ  - Logging      ‚îÇ                ‚îÇ  - Tokens   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                 ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò                ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### 1. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–î–æ–±–∞–≤—å—Ç–µ –≤ `.env` —Ñ–∞–π–ª:

```bash
# amoCRM Webhook Configuration
AMOCRM_CLIENT_ID=your_client_id
AMOCRM_CLIENT_SECRET=your_client_secret
AMOCRM_DOMAIN=your-company.amocrm.ru
AMOCRM_REDIRECT_URI=http://localhost:8000/api/auth/amo/callback

# Database
DB_URL=postgresql://asia:asia@db:5432/asia_crm

# Security
SECRET_KEY=your-secret-key
JWT_SECRET=your-jwt-secret

# Logging
LOG_LEVEL=INFO
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ webhook –≤ amoCRM

1. **–í–æ–π–¥–∏—Ç–µ –≤ amoCRM** –ø–æ–¥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º
2. **–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ù–∞—Å—Ç—Ä–æ–π–∫–∏** ‚Üí **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏** ‚Üí **Webhooks**
3. **–î–æ–±–∞–≤—å—Ç–µ –Ω–æ–≤—ã–π webhook:**

```
URL: http://your-domain.com/api/webhooks/amo
–°–æ–±—ã—Ç–∏—è:
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–æ–≤
‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–∏–¥–æ–≤
‚úÖ –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–¥–æ–≤
‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤
```

### 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–µ–π

–°–æ–∑–¥–∞–π—Ç–µ –≤ amoCRM –∫–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è —Å —É–∫–∞–∑–∞–Ω–Ω—ã–º–∏ ID:

#### –î–ª—è –ª–∏–¥–æ–≤:
| –ü–æ–ª–µ | ID | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----|-----|----------|
| UTM Source | 123458 | –¢–µ–∫—Å—Ç | –ò—Å—Ç–æ—á–Ω–∏–∫ —Ç—Ä–∞—Ñ–∏–∫–∞ |
| UTM Medium | 123459 | –¢–µ–∫—Å—Ç | –ö–∞–Ω–∞–ª —Ç—Ä–∞—Ñ–∏–∫–∞ |
| UTM Campaign | 123460 | –¢–µ–∫—Å—Ç | –ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞–º–ø–∞–Ω–∏–∏ |
| UTM Content | 123461 | –¢–µ–∫—Å—Ç | –ö–æ–Ω—Ç–µ–Ω—Ç |
| UTM Term | 123462 | –¢–µ–∫—Å—Ç | –ö–ª—é—á–µ–≤—ã–µ —Å–ª–æ–≤–∞ |
| –°—Ç–æ–∏–º–æ—Å—Ç—å –æ–±—ä–µ–∫—Ç–∞ | 123463 | –ß–∏—Å–ª–æ | –°—Ç–æ–∏–º–æ—Å—Ç—å –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏ |
| –ö–æ–º–∏—Å—Å–∏—è | 123464 | –ß–∏—Å–ª–æ | –ö–æ–º–∏—Å—Å–∏—è –∞–≥–µ–Ω—Ç–∞ |

#### –î–ª—è –∫–æ–Ω—Ç–∞–∫—Ç–æ–≤:
| –ü–æ–ª–µ | ID | –¢–∏–ø | –û–ø–∏—Å–∞–Ω–∏–µ |
|------|----|-----|----------|
| –¢–µ–ª–µ—Ñ–æ–Ω | 123456 | –¢–µ–ª–µ—Ñ–æ–Ω | –û—Å–Ω–æ–≤–Ω–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω |
| Email | 123457 | Email | –û—Å–Ω–æ–≤–Ω–æ–π email |

## üöÄ –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

### –õ–æ–∫–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫

```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
cd backend
pip install -r requirements.txt

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

### Docker –∑–∞–ø—É—Å–∫

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose up -d

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤
docker-compose logs -f backend
```

## üì° API Endpoints

### –û—Å–Ω–æ–≤–Ω–æ–π webhook endpoint

```
POST /api/webhooks/amo
```

**Headers:**
- `X-Client-UUID` - UUID –∫–ª–∏–µ–Ω—Ç–∞ amoCRM
- `X-Signature` - HMAC –ø–æ–¥–ø–∏—Å—å
- `X-Account-ID` - ID –∞–∫–∫–∞—É–Ω—Ç–∞ amoCRM
- `Content-Type: application/json`

**Body:**
```json
{
  "leads": {
    "add": [
      {
        "id": 12345,
        "name": "–ù–æ–≤—ã–π –ª–∏–¥",
        "status_id": 1,
        "created_at": 1640995200,
        "custom_fields_values": [
          {
            "field_id": 123458,
            "values": [{"value": "google"}]
          }
        ]
      }
    ],
    "update": [],
    "delete": []
  },
  "contacts": {
    "add": [],
    "update": []
  }
}
```

**Response:**
```json
{
  "status": "success",
  "message": "Processed 1 events",
  "events_processed": 1,
  "timestamp": "2024-01-01T12:00:00Z",
  "errors": null
}
```

### –¢–µ—Å—Ç–æ–≤—ã–µ endpoints

#### Health check
```
GET /api/webhooks/amo/health
```

**Response:**
```json
{
  "status": "healthy",
  "timestamp": "2024-01-01T12:00:00Z",
  "database": "connected",
  "webhook_endpoint": "active"
}
```

#### Test endpoint
```
GET /api/webhooks/amo/test
```

**Response:**
```json
{
  "status": "success",
  "message": "Webhook endpoint is working",
  "timestamp": "2024-01-01T12:00:00Z",
  "endpoint": "/api/webhooks/amo",
  "supported_events": [
    "leads.add",
    "leads.update",
    "leads.delete",
    "contacts.add",
    "contacts.update"
  ]
}
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã

```bash
# –ó–∞–ø—É—Å–∫ unit —Ç–µ—Å—Ç–æ–≤
cd backend
pytest tests/unit/test_webhooks.py -v

# –ó–∞–ø—É—Å–∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤
pytest tests/integration/ -v
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
python scripts/test_webhook_server.py

# –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∫–∞—Å—Ç–æ–º–Ω—ã–º URL
python scripts/test_webhook_server.py http://localhost:8000
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ curl

```bash
# Health check
curl -X GET http://localhost:8000/api/webhooks/amo/health

# Test endpoint
curl -X GET http://localhost:8000/api/webhooks/amo/test

# –¢–µ—Å—Ç–æ–≤—ã–π webhook
curl -X POST http://localhost:8000/api/webhooks/amo \
  -H "Content-Type: application/json" \
  -H "X-Client-UUID: test-uuid" \
  -H "X-Signature: test-signature" \
  -H "X-Account-ID: test-account" \
  -d '{
    "leads": {
      "add": [{"id": 123, "name": "Test Lead"}]
    }
  }'
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–ø–∏—Å–∏

Webhook –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è —Å –ø–æ–º–æ—â—å—é HMAC-SHA256 –ø–æ–¥–ø–∏—Å–∏:

```python
def verify_webhook_signature(client_uuid, signature, account_id, client_secret):
    message = f"{client_uuid}|{account_id}"
    expected_signature = hmac.new(
        client_secret.encode('utf-8'),
        message.encode('utf-8'),
        hashlib.sha256
    ).hexdigest()
    return hmac.compare_digest(signature, expected_signature)
```

### –í–∞–ª–∏–¥–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö

–í—Å–µ –≤—Ö–æ–¥—è—â–∏–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ö–æ–¥—è—Ç –≤–∞–ª–∏–¥–∞—Ü–∏—é:

1. **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ JSON
2. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è ID
3. **–¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤ –ø–æ–ª–µ–π
4. **–†–∞–∑–º–µ—Ä –¥–∞–Ω–Ω—ã—Ö** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ payload

## üìä –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–æ–±—ã—Ç–∏–π

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Å–æ–±—ã—Ç–∏—è

| –°–æ–±—ã—Ç–∏–µ | –û–ø–∏—Å–∞–Ω–∏–µ | –û–±—Ä–∞–±–æ—Ç–∫–∞ |
|---------|----------|-----------|
| `leads.add` | –°–æ–∑–¥–∞–Ω–∏–µ –ª–∏–¥–∞ | –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ –ë–î |
| `leads.update` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ª–∏–¥–∞ | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ –¥–∞–Ω–Ω—ã—Ö |
| `leads.delete` | –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏–¥–∞ | –ü–æ–º–µ—á–∞–Ω–∏–µ –∫–∞–∫ —É–¥–∞–ª–µ–Ω–Ω—ã–π |
| `contacts.add` | –°–æ–∑–¥–∞–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω—Ç–∞–∫—Ç–µ |
| `contacts.update` | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ç–∞–∫—Ç–∞ | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞/email |

### –ú–∞–ø–ø–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–æ–≤

| amoCRM Status ID | –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π —Å—Ç–∞—Ç—É—Å | –û–ø–∏—Å–∞–Ω–∏–µ |
|------------------|-------------------|----------|
| 1 | `new` | –ù–æ–≤—ã–π –ª–∏–¥ |
| 2 | `contacted` | –ü–µ—Ä–≤–∏—á–Ω—ã–π –∫–æ–Ω—Ç–∞–∫—Ç |
| 3 | `presentation` | –ü—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏—è |
| 4 | `object_selected` | –í—ã–±–æ—Ä –æ–±—ä–µ–∫—Ç–∞ |
| 5 | `reserved` | –†–µ–∑–µ—Ä–≤–∏—Ä–æ–≤–∞–Ω–∏–µ |
| 6 | `deal` | –°–¥–µ–ª–∫–∞ |
| 7 | `completed` | –ó–∞–≤–µ—Ä—à–µ–Ω–æ |

### –û–±—Ä–∞–±–æ—Ç–∫–∞ UTM –º–µ—Ç–æ–∫

UTM –º–µ—Ç–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞—é—Ç—Å—è –∏–∑ –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª–µ–π:

```python
def _extract_utm_data(data):
    utm_mapping = {
        123458: "utm_source",    # UTM Source
        123459: "utm_medium",    # UTM Medium
        123460: "utm_campaign",  # UTM Campaign
        123461: "utm_content",   # UTM Content
        123462: "utm_term"       # UTM Term
    }
    # –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –º–∞–ø–ø–∏–Ω–≥ –∑–Ω–∞—á–µ–Ω–∏–π
```

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è

- **INFO** - –£—Å–ø–µ—à–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
- **WARNING** - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- **ERROR** - –û—à–∏–±–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∫–∏
- **DEBUG** - –î–µ—Ç–∞–ª—å–Ω–∞—è –æ—Ç–ª–∞–¥–∫–∞

### –ü—Ä–∏–º–µ—Ä—ã –ª–æ–≥–æ–≤

```
INFO: Received webhook from amoCRM: {"leads": {"add": [{"id": 12345}]}}
INFO: Webhook signature verified for account: test-account
INFO: New lead created from amoCRM: 12345
INFO: Webhook processed 1 events in 0.15s
```

### –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤

```bash
# Docker
docker-compose logs -f backend

# –õ–æ–∫–∞–ª—å–Ω–æ
tail -f logs/app.log

# –ü–æ–∏—Å–∫ –æ—à–∏–±–æ–∫
grep "ERROR" logs/app.log
```

## üö® –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### –¢–∏–ø—ã –æ—à–∏–±–æ–∫

| –ö–æ–¥ | –û–ø–∏—Å–∞–Ω–∏–µ | –†–µ—à–µ–Ω–∏–µ |
|-----|----------|---------|
| 400 | –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É JSON |
| 401 | –ù–µ–≤–∞–ª–∏–¥–Ω–∞—è –ø–æ–¥–ø–∏—Å—å | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å client_secret |
| 500 | –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è –æ—à–∏–±–∫–∞ | –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ |

### Retry –ª–æ–≥–∏–∫–∞

–ü—Ä–∏ –æ—à–∏–±–∫–∞—Ö –æ–±—Ä–∞–±–æ—Ç–∫–∏:

1. **–ü–µ—Ä–≤–∞—è –ø–æ–ø—ã—Ç–∫–∞** - –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
2. **–í—Ç–æ—Ä–∞—è –ø–æ–ø—ã—Ç–∫–∞** - —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
3. **–¢—Ä–µ—Ç—å—è –ø–æ–ø—ã—Ç–∫–∞** - —á–µ—Ä–µ–∑ 30 —Å–µ–∫—É–Ω–¥
4. **–§–∏–Ω–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞** - –∑–∞–ø–∏—Å—å –≤ –ª–æ–≥

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –æ—à–∏–±–æ–∫

```bash
# –ü–æ–¥—Å—á–µ—Ç –æ—à–∏–±–æ–∫
grep -c "ERROR" logs/app.log

# –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º –æ—à–∏–±–æ–∫
grep "ERROR" logs/app.log | awk '{print $NF}' | sort | uniq -c
```

## üîÑ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –º–µ—Ç—Ä–∏–∫–∏

### Health check

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞
curl -X GET http://localhost:8000/api/webhooks/amo/health

# –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞
watch -n 30 'curl -s http://localhost:8000/api/webhooks/amo/health'
```

### –ú–µ—Ç—Ä–∏–∫–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

- **–í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏** - —Å—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook
- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–æ–±—ã—Ç–∏–π** - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ —Ç–∏–ø–∞–º —Å–æ–±—ã—Ç–∏–π
- **–û—à–∏–±–∫–∏** - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ —Ç–∏–ø—ã –æ—à–∏–±–æ–∫
- **–î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å** - uptime —Å–µ—Ä–≤–∏—Å–∞

### –ê–ª–µ—Ä—Ç—ã

–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∞–ª–µ—Ä—Ç—ã –¥–ª—è:

- –û—à–∏–±–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏ webhook
- –í—ã—Å–æ–∫–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –æ—Ç–∫–ª–∏–∫–∞
- –ù–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞
- –û—à–∏–±–æ–∫ –ë–î

## üîß Troubleshooting

### –ß–∞—Å—Ç—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

#### 1. "Invalid signature"
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π client_secret
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ amoCRM

#### 2. "Database connection failed"
**–ü—Ä–∏—á–∏–Ω–∞:** –ü—Ä–æ–±–ª–µ–º—ã —Å –ë–î
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

#### 3. "Field not found"
**–ü—Ä–∏—á–∏–Ω–∞:** –ö–∞—Å—Ç–æ–º–Ω—ã–µ –ø–æ–ª—è –Ω–µ —Å–æ–∑–¥–∞–Ω—ã
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å –ø–æ–ª—è —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ ID

#### 4. "Webhook not received"
**–ü—Ä–∏—á–∏–Ω–∞:** –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å
**–†–µ—à–µ–Ω–∏–µ:** –ü—Ä–æ–≤–µ—Ä–∏—Ç—å URL –∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–µ—Ä–∞

### –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞
curl -X GET http://localhost:8000/api/webhooks/amo/health

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤
docker-compose logs backend | tail -50

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–î
docker-compose exec db psql -U asia -d asia_crm -c "SELECT COUNT(*) FROM leads;"

# –¢–µ—Å—Ç webhook
python scripts/test_webhook_server.py
```

## üìà –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

1. **–ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞** - –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ async/await
2. **–ë–∞—Ç—á–∏–Ω–≥** - –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –æ–ø–µ—Ä–∞—Ü–∏–π –ë–î
3. **–ö—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫—ç—à —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
4. **Connection pooling** - –ø—É–ª —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –ë–î

### –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ì–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω–æ–µ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ** - –Ω–µ—Å–∫–æ–ª—å–∫–æ –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤
2. **Load balancing** - –±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏
3. **Queue system** - –æ—á–µ—Ä–µ–¥—å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
4. **Database sharding** - —à–∞—Ä–¥–∏–Ω–≥ –ë–î

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏—è

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
docker-compose down

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
git pull origin main

# –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫
docker-compose up -d --build

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
docker-compose logs -f backend
```

### –ú–∏–≥—Ä–∞—Ü–∏–∏ –ë–î

```bash
# –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
docker-compose exec backend alembic upgrade head

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ –º–∏–≥—Ä–∞—Ü–∏–π
docker-compose exec backend alembic current
```

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

### –ö–æ–Ω—Ç–∞–∫—Ç—ã

- **Email:** support@asia-deals.com
- **Telegram:** @asia_deals_support
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** `/docs`

### –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã

```bash
# –ü–æ–ª–Ω—ã–π —Å—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã
docker-compose ps

# –õ–æ–≥–∏ –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
docker-compose logs

# –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ webhook —Å–µ—Ä–≤–µ—Ä–∞
docker-compose restart backend

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
docker-compose config
```

---

**–ì–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ!** üöÄ

–í–µ–±—Ö—É–∫ —Å–µ—Ä–≤–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ—Ç amoCRM.
